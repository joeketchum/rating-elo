﻿<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hockey Rater</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- HOCKEY RATER - FORCE REDEPLOY 2025-10-04 -->
  <meta name="version" content="hockey-rater-v1">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    body { 
      padding: 0; 
      margin: 0; 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', 'Helvetica Neue', Arial, sans-serif;
    }
    * {
      font-family: inherit;
    }
    
    /* Toast notification animation */
    @keyframes slideInFromRight {
      0% {
        transform: translateX(100%);
        opacity: 0;
      }
      100% {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes fadeOut {
      0% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(100%);
      }
    }
  </style>
</head>

<body>

<pre id="elm"></pre>

<script src="elm.js?v=20251006d"></script>
<script>
try {
  console.log("Initializing Elm app...");
  console.log("Elm object:", typeof Elm !== 'undefined' ? 'found' : 'NOT FOUND');
  
  if (typeof Elm === 'undefined') {
    document.getElementById('elm').innerText = 'ERROR: Elm not loaded. Check elm.js file.';
    throw new Error('Elm is not defined');
  }
  
  if (!Elm.Main) {
    document.getElementById('elm').innerText = 'ERROR: Elm.Main not found.';
    throw new Error('Elm.Main is not defined');  
  }
  
  console.log("Creating Elm app with Supabase backend...");
  var app = Elm.Main.init({
    node: document.getElementById('elm')
  });
  
  console.log("Elm app created successfully:", app);

  // Simple localStorage keys for local preferences
  var LS_FILTER = "EloTrackerTimeFilter"; // 'all' | 'am' | 'pm'
  var LS_IGNORED = "EloTrackerIgnoredPlayers"; // comma-separated player IDs
  
  console.log("Setting up ports for local preferences...");

  if (app.ports.autoSave && app.ports.autoSave.subscribe) {
    app.ports.autoSave.subscribe(function(json) {
      try { localStorage.setItem(LS_KEY, json); } catch (_) {}
    });
  }

  // Persist time filter
  if (app.ports.saveTimeFilter && app.ports.saveTimeFilter.send) {
    // nothing to subscribe; it's a command port used from Elm
  }
  if (app.ports.receiveTimeFilter && app.ports.receiveTimeFilter.subscribe) {
    // nothing; Elm subscribes here
  }
  if (app.ports.askForTimeFilter && app.ports.askForTimeFilter.send) {
    // On init, read filter and send to Elm
    var stored = '';
    try { stored = localStorage.getItem(LS_FILTER) || ''; } catch(_) {}
    if (app.ports.receiveTimeFilter && app.ports.receiveTimeFilter.subscribe) {
      // subscribe not needed; Elm already subscribed. We'll send through a synthetic path:
    }
    // Set up listeners so Elm can save filter changes
    app.ports.saveTimeFilter && app.ports.saveTimeFilter.subscribe && app.ports.saveTimeFilter.subscribe(function(val){
      try { localStorage.setItem(LS_FILTER, val); } catch(_) {}
    });
    // Send initial value to Elm
    if (app.ports.receiveTimeFilter && app.ports.receiveTimeFilter.send) {
      app.ports.receiveTimeFilter.send(stored);
    }
    // Also ask for current (noop payload)
    app.ports.askForTimeFilter.send('');
  }

  // Handle ignored players persistence
  if (app.ports.askForIgnoredPlayers && app.ports.askForIgnoredPlayers.send) {
    var storedIgnored = '';
    try { storedIgnored = localStorage.getItem(LS_IGNORED) || ''; } catch(_) {}
    
    // Set up listeners so Elm can save ignored players changes
    app.ports.saveIgnoredPlayers && app.ports.saveIgnoredPlayers.subscribe && app.ports.saveIgnoredPlayers.subscribe(function(val){
      try { localStorage.setItem(LS_IGNORED, val); } catch(_) {}
    });
    
    // Send initial value to Elm
    if (app.ports.receiveIgnoredPlayers && app.ports.receiveIgnoredPlayers.send) {
      app.ports.receiveIgnoredPlayers.send(storedIgnored);
    }
    
    // Also ask for current (noop payload)
    app.ports.askForIgnoredPlayers.send('');
  }

  if (app.ports.loadStandings && app.ports.loadStandings.subscribe) {
    app.ports.loadStandings.subscribe(function(useless) {
      var json = '';
      try { json = localStorage.getItem(LS_KEY) || ''; } catch (_) {}
      if (app.ports.receiveStandings && app.ports.receiveStandings.send) {
        app.ports.receiveStandings.send(json);
      } 
    });
  }

  // No Google Drive save needed - data is stored in Supabase
  // Keeping ports for backwards compatibility but no actual save operation

  // No Google Drive reload needed - data comes from Supabase
  // Keeping function stub for backwards compatibility
  function reloadFromPublicDrive(){
    console.log('reloadFromPublicDrive called but no action needed - data comes from Supabase');
  }

  // No Google Drive loading needed - data comes from Supabase
  // Keeping port for backwards compatibility but no operation
  if (app.ports.loadFromPublicDrive && app.ports.loadFromPublicDrive.subscribe) {       
    app.ports.loadFromPublicDrive.subscribe(function(){
      console.log('loadFromPublicDrive called but no action needed - data comes from Supabase');
    });
  }
  
  console.log("All port subscriptions set up successfully");
  
  // Add debug info to page title for vote count tracking
  if (app.ports.sendVoteCount && app.ports.sendVoteCount.subscribe) {
    app.ports.sendVoteCount.subscribe(function(count) {
      document.title = `ELO Ratings (${count} votes until auto-save)`;
    });
  }
}
catch (e) {
  console.error("Initialization error:", e);
  // Display initialization errors
  var header = document.createElement("h1");
  header.style.fontFamily = "monospace";
  header.style.color = "red";
  header.innerText = "Initialization Error";
  var pre = document.getElementById("elm");
  document.body.insertBefore(header, pre);
  pre.innerText = e.toString();
  pre.style.color = "red";
  pre.style.background = "#ffe6e6";
  pre.style.padding = "10px";
}
</script>

</body>
</html>