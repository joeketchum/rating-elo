<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <style>
    body { 
      padding: 0; 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }
    * {
      font-family: inherit;
    }
  </style>
</head>

<body>

<pre id="elm"></pre>

<script src="elm.js"></script>
<script>
try {
  console.log("Initializing Elm app...");
  console.log("Elm object:", typeof Elm !== 'undefined' ? 'found' : 'NOT FOUND');
  
  if (typeof Elm === 'undefined') {
    document.getElementById('elm').innerText = 'ERROR: Elm not loaded. Check elm.js file.';
    throw new Error('Elm is not defined');
  }
  
  if (!Elm.Main) {
    document.getElementById('elm').innerText = 'ERROR: Elm.Main not found.';
    throw new Error('Elm.Main is not defined');  
  }
  
  console.log("Creating Elm app...");
  var app = Elm.Main.init({
    node: document.getElementById('elm')
  });
  
  console.log("Elm app created successfully:", app);

  // Send initial config
  if (app.ports.askForAutoSave && app.ports.askForAutoSave.send) {
    app.ports.askForAutoSave.send('');
  }

  // Set up all the port subscriptions
  var LS_KEY = "EloTrackerData";
  var LS_PUBLIC = "EloTrackerPublic";

  if (app.ports.autoSave && app.ports.autoSave.subscribe) {
    app.ports.autoSave.subscribe(function(json) {
      try { localStorage.setItem(LS_KEY, json); } catch (_) {}
    });
  }

  if (app.ports.loadStandings && app.ports.loadStandings.subscribe) {
    app.ports.loadStandings.subscribe(function(useless) {
      var json = '';
      try { json = localStorage.getItem(LS_KEY) || ''; } catch (_) {}
      if (app.ports.receiveStandings && app.ports.receiveStandings.send) {
        app.ports.receiveStandings.send(json);
      } 
    });
  }

  // Subscribe to the automatic save for matches 
  if (app.ports.saveToPublicDrive && app.ports.saveToPublicDrive.subscribe) {
    app.ports.saveToPublicDrive.subscribe(function(json) {
      try { localStorage.setItem(LS_PUBLIC, json); } catch (_) {}

      // Google Apps Script URL for your deployed web app
      var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx4Vo9hj74V_bOIRzpP9jrDrC1EhBBdnfUKUHlOGhElCDmGjSJm6LZdN4yXY5ZkEWLnzA/exec';
      
      // Send to Google Apps Script
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          data: json,
          timestamp: new Date().toISOString()
        })
      })
      .then(function(response) {
        console.log('Apps Script Response Status:', response.status);
        return response.text().then(function(text) {
          console.log('Apps Script Response Text:', text);
          var ok = response.ok;
          var msg = ok ? 'Saved successfully to Google Sheets' : ('Save failed: ' + response.status + ' ' + text);
          
          // Check if this was a match save (compact JSON) vs manual save (formatted JSON)
          var isMatchSave = json.indexOf('\n') === -1; // No newlines = compact = match save

          if (app.ports.receivePublicDriveStatus && app.ports.receivePublicDriveStatus.send) {
            var ts = new Date().toISOString();
            app.ports.receivePublicDriveStatus.send(msg + (ok ? ('|' + ts) : ''));      
          }

          // If this was a successful match save, trigger the completion port
          if (ok && isMatchSave && app.ports.receiveMatchSaveComplete && app.ports.receiveMatchSaveComplete.send) {
            app.ports.receiveMatchSaveComplete.send(null);        
          }
        });
      })
      .catch(function(err) {
        console.error('Drive save failed:', err);
        if (app.ports.receivePublicDriveStatus && app.ports.receivePublicDriveStatus.send) {
          app.ports.receivePublicDriveStatus.send('Drive save failed: ' + String(err)); 
        }
      });
    });
  }

  // Load from public copy in localStorage (fallback)
  if (app.ports.loadFromPublicDrive && app.ports.loadFromPublicDrive.subscribe) {       
    app.ports.loadFromPublicDrive.subscribe(function(){
      var json = '';  
      try { json = localStorage.getItem(LS_PUBLIC) || ''; } catch(_) {}
      if (app.ports.receiveStandings && app.ports.receiveStandings.send) {
        app.ports.receiveStandings.send(json);
      }
    });
  }
  
  console.log("All port subscriptions set up successfully");
}
catch (e) {
  console.error("Initialization error:", e);
  // Display initialization errors
  var header = document.createElement("h1");
  header.style.fontFamily = "monospace";
  header.style.color = "red";
  header.innerText = "Initialization Error";
  var pre = document.getElementById("elm");
  document.body.insertBefore(header, pre);
  pre.innerText = e.toString();
  pre.style.color = "red";
  pre.style.background = "#ffe6e6";
  pre.style.padding = "10px";
}
</script>

</body>
</html>
