<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>The Rating Game</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <style>
    body { 
      padding: 0; 
      margin: 0; 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', 'Helvetica Neue', Arial, sans-serif;
    }
    * {
      font-family: inherit;
    }
  </style>
</head>

<body>

<pre id="elm"></pre>

<script src="elm.js"></script>
<script>
try {
  console.log("Initializing Elm app...");
  console.log("Elm object:", typeof Elm !== 'undefined' ? 'found' : 'NOT FOUND');
  
  if (typeof Elm === 'undefined') {
    document.getElementById('elm').innerText = 'ERROR: Elm not loaded. Check elm.js file.';
    throw new Error('Elm is not defined');
  }
  
  if (!Elm.Main) {
    document.getElementById('elm').innerText = 'ERROR: Elm.Main not found.';
    throw new Error('Elm.Main is not defined');  
  }
  
  console.log("Creating Elm app...");
  var app = Elm.Main.init({
    node: document.getElementById('elm')
  });
  
  console.log("Elm app created successfully:", app);

  // Send initial config
  if (app.ports.askForAutoSave && app.ports.askForAutoSave.send) {
    app.ports.askForAutoSave.send('');
  }

  // Set up all the port subscriptions
  var LS_KEY = "EloTrackerData";
  var LS_PUBLIC = "EloTrackerPublic";

  if (app.ports.autoSave && app.ports.autoSave.subscribe) {
    app.ports.autoSave.subscribe(function(json) {
      try { localStorage.setItem(LS_KEY, json); } catch (_) {}
    });
  }

  if (app.ports.loadStandings && app.ports.loadStandings.subscribe) {
    app.ports.loadStandings.subscribe(function(useless) {
      var json = '';
      try { json = localStorage.getItem(LS_KEY) || ''; } catch (_) {}
      if (app.ports.receiveStandings && app.ports.receiveStandings.send) {
        app.ports.receiveStandings.send(json);
      } 
    });
  }

  // Subscribe to the automatic save for matches 
  if (app.ports.saveToPublicDrive && app.ports.saveToPublicDrive.subscribe) {
    app.ports.saveToPublicDrive.subscribe(function(json) {
      try { localStorage.setItem(LS_PUBLIC, json); } catch (_) {}

      // Google Apps Script URL for your deployed web app
      var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMKDAGq7vWDi8lh-MBCwTYUlOLMqTiGol877LO2R2Mt5wL_fm1-LDYXAq-m1eEN3WJTg/exec';
      
      // Send to Google Apps Script (send raw JSON data)
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: json
      })
      .then(function(response) {
        console.log('Apps Script Response Status:', response.status);
        return response.json().then(function(result) {
          console.log('Apps Script Response:', result);
          var ok = response.ok && result.ok;
          var msg = ok ? 'Saved successfully to Google Drive (' + result.bytes + ' bytes)' : ('Save failed: ' + (result.error || 'Unknown error'));
          
          // Check if this was a match save (compact JSON) vs manual save (formatted JSON)
          var isMatchSave = json.indexOf('\n') === -1; // No newlines = compact = match save
          
          // Debug: Log what we're checking
          console.log('SAVE COMPLETION CHECK:', { 
            ok: ok, 
            isMatchSave: isMatchSave, 
            jsonLength: json.length,
            hasNewlines: json.indexOf('\n') !== -1,
            jsonPreview: json.substring(0, 100) + '...'
          });

          if (app.ports.receivePublicDriveStatus && app.ports.receivePublicDriveStatus.send) {
            var ts = new Date().toISOString();
            app.ports.receivePublicDriveStatus.send(msg + (ok ? ('|' + ts) : ''));      
          }

          // Always send completion signal for successful saves (auto-save or manual)
          // The Elm code can determine if it should reload based on its state
          if (ok && app.ports.receiveMatchSaveComplete && app.ports.receiveMatchSaveComplete.send) {
            console.log('AUTO-SAVE COMPLETED: Sending completion signal to Elm');
            app.ports.receiveMatchSaveComplete.send(null);        
          } else {
            console.log('AUTO-SAVE COMPLETION CONDITIONS:', { ok: ok, hasPort: !!(app.ports.receiveMatchSaveComplete && app.ports.receiveMatchSaveComplete.send) });
          }
        });
      })
      .catch(function(err) {
        console.error('Drive save failed:', err);
        var errorMsg = 'Auto-save temporarily unavailable (CORS/network issue). Data saved locally.';
        
        if (app.ports.receivePublicDriveStatus && app.ports.receivePublicDriveStatus.send) {
          app.ports.receivePublicDriveStatus.send(errorMsg); 
        }
        // Reset auto-save state on error so voting can continue
        if (app.ports.receiveMatchSaveComplete && app.ports.receiveMatchSaveComplete.send) {
          console.log('AUTO-SAVE ERROR: Sending completion signal to re-enable voting');
          app.ports.receiveMatchSaveComplete.send(null);
        }
      });
    });
  }

  // Load from Google Drive, fallback to localStorage
  if (app.ports.loadFromPublicDrive && app.ports.loadFromPublicDrive.subscribe) {       
    app.ports.loadFromPublicDrive.subscribe(function(){
      var APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwMKDAGq7vWDi8lh-MBCwTYUlOLMqTiGol877LO2R2Mt5wL_fm1-LDYXAq-m1eEN3WJTg/exec';
      
      // Try to load from Google Drive first
      fetch(APPS_SCRIPT_URL, { method: 'GET' })
        .then(function(response) {
          if (response.ok) {
            return response.text();
          } else {
            throw new Error('Failed to load from Google Drive');
          }
        })
        .then(function(json) {
          console.log('Loaded data from Google Drive:', json.length, 'bytes');
          if (app.ports.receiveStandings && app.ports.receiveStandings.send) {
            app.ports.receiveStandings.send(json);
          }
        })
        .catch(function(error) {
          console.log('Loading from Google Drive failed, using localStorage:', error);
          // Fallback to localStorage
          var json = '';  
          try { json = localStorage.getItem(LS_PUBLIC) || ''; } catch(_) {}
          if (app.ports.receiveStandings && app.ports.receiveStandings.send) {
            app.ports.receiveStandings.send(json);
          }
        });
    });
  }
  
  console.log("All port subscriptions set up successfully");
}
catch (e) {
  console.error("Initialization error:", e);
  // Display initialization errors
  var header = document.createElement("h1");
  header.style.fontFamily = "monospace";
  header.style.color = "red";
  header.innerText = "Initialization Error";
  var pre = document.getElementById("elm");
  document.body.insertBefore(header, pre);
function doGet(e) {
  return ContentService.createTextOutput('{"test": "success", "timestamp": "' + new Date().toISOString() + '"}')
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const body = e.postData ? e.postData.contents : 'no body';
  return ContentService.createTextOutput('{"received": true, "bodyLength": ' + body.length + ', "timestamp": "' + new Date().toISOString() + '"}')
    .setMimeType(ContentService.MimeType.JSON);
}  pre.innerText = e.toString();
  pre.style.color = "red";
  pre.style.background = "#ffe6e6";
  pre.style.padding = "10px";
}
</script>

</body>
</html>
